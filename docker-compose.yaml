services:
  jupyter:
    image: jupyter/pyspark-notebook
    container_name: jupyter-pyspark-lab
    ports:
      - "${PORT_JUPYTER}:${PORT_JUPYTER}"
      - "${PORT_SPARK}:${PORT_SPARK}"
    working_dir: /home/jovyan/work
    volumes:
      - ./libros:/home/jovyan/work
      - ./.env:/home/jovyan/.env
      - ./drivers:/home/jovyan/drivers
    depends_on:
      warehouses:
        condition: service_healthy
    environment:
      - JUPYTER_TOKEN=${JUPYTER_TOKEN}
      - SPARK_LOCAL_IP=${SPARK_LOCAL_IP}
      - PYSPARK_PYTHON=${PYSPARK_PYTHON}
    command: start-notebook.sh --NotebookApp.token='${JUPYTER_TOKEN}'

  warehouses:
    image: postgres:15
    container_name: postgres-warehouse
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - "./warehouse_data:/var/lib/postgresql/data:rw"  
      - "./init-scripts:/docker-entrypoint-initdb.d:ro"
    ports:
      - "${PORT_POSTGRES}:${PORT_POSTGRES}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"] 
      interval: 30s
      timeout: 10s
      retries: 3

  warehousesui:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
    volumes:
      - "./warehouse_ui_data:/var/lib/pgadmin"
    ports:
      - "${PORT_WAREHOUSEUI}:80"
    depends_on:
      warehouses:
        condition: service_healthy

  feature-builder:
    build:
      context: .
      dockerfile: Dockerfile.feature-builder
    environment:
      - PG_HOST=warehouses 
      - PG_PORT=${PORT_POSTGRES}
      - PG_DB=${POSTGRES_DB}
      - PG_USER=${POSTGRES_USER}
      - PG_PASSWORD=${POSTGRES_PASSWORD}
      - PG_SCHEMA_RAW=raw
      - PG_SCHEMA_ANALYTICS=analytics
    volumes:
      - ./scripts:/app/scripts
      - ./logs:/app/logs
    depends_on:
      warehouses:
        condition: service_healthy

  model-api:
    build:
      context: ./model-api
      dockerfile: Dockerfile
    environment:
      - MODEL_PATH=${MODEL_PATH}
      - API_PORT=${API_PORT}
    volumes:
      - ./models:/models
    ports:
      - "${API_PORT}:8000"
    depends_on:
      warehouses:
        condition: service_healthy